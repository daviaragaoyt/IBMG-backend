// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// 1. PESSOAS E ACESSOS
// ============================================================================

model Person {
  id              String     @id @default(uuid())
  name            String
  email           String?    @unique // Obrigatório para Staff logar
  phone           String?
  age             Int?
  gender          String?    // 'M' ou 'F'
  
  type            PersonType @default(VISITOR)
  role            Role       @default(PARTICIPANT)
   
  // Define qual tela o Staff vê (KIDS, CANTINA, RECEPTION, etc)
  department      String?    
   
  church          String?
  marketingSource String?    // Ex: "Instagram", "Decisão: Aceitou Jesus"
   
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  movements       Movement[]
  orders          Order[]    // Relacionamento com pedidos da pré-venda/online

  @@map("people")
}

model Checkpoint {
  id            String             @id @default(uuid())
  name          String             @unique
  category      CheckpointCategory @default(GENERAL)

  movements     Movement[]
  manualEntries ManualEntry[]
  sales         Sale[]

  @@map("checkpoints")
}

model Movement {
  id           String     @id @default(uuid())
  timestamp    DateTime   @default(now())
   
  personId     String
  person       Person     @relation(fields: [personId], references: [id])
  checkpointId String
  checkpoint   Checkpoint @relation(fields: [checkpointId], references: [id])

  @@map("movements")
}

model ManualEntry {
  id              String     @id @default(uuid())
  timestamp       DateTime   @default(now())
  quantity        Int        @default(1)

  type            PersonType
  gender          String?
  ageGroup        String?
  church          String?
  marketingSource String?    // Tags como "VIDA_SALVA", "CURA"

  checkpointId    String
  checkpoint      Checkpoint @relation(fields: [checkpointId], references: [id])

  @@map("manual_entries")
}

// ============================================================================
// 2. PRODUTOS E VENDAS (POS / LOJA FÍSICA)
// ============================================================================

model Product {
  id          String      @id @default(uuid())
  name        String
  price       Decimal     @db.Decimal(10, 2)
  category    String      // 'CANTINA' ou 'LOJA'
  imageUrl    String?     // Foto do produto
   
  saleItems   SaleItem[]
  orderItems  OrderItem[]

  @@map("products")
}

model Sale {
  id            String   @id @default(uuid())
  timestamp     DateTime @default(now())
  total         Decimal  @db.Decimal(10, 2)
  paymentMethod String   // PIX, DINHEIRO, CARTAO, PENDING
  
  // --- CAMPOS NOVOS NECESSÁRIOS PARA O CHECKOUT ---
  buyerName     String?  // <--- O CAMPO QUE ESTAVA FALTANDO
  orderCode     String?  // Para o código curto (A1B2)
  status        String   @default("COMPLETED") // PENDING, PAID, DELIVERED
  // ------------------------------------------------

  buyerType     PersonType @default(VISITOR)
  buyerGender   String     @default("M")

  // Tornamos o Checkpoint opcional (?) pois o pedido online 
  // pode ser criado sem estar fisicamente num balcão ainda
  checkpointId  String?    
  checkpoint    Checkpoint? @relation(fields: [checkpointId], references: [id])
  
  items         SaleItem[]

  @@map("sales")
}

model SaleItem {
  id        String  @id @default(uuid())
  saleId    String
  sale      Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int
  price     Decimal @db.Decimal(10, 2) // Preço congelado no momento da venda

  @@map("sale_items")
}
model Order {
  id          String      @id @default(uuid())
  orderCode   String      @unique // Código curto ex: "A1B2"
   
  // PersonId é OBRIGATÓRIO (Checkout identificado)
  personId    String      
  person      Person      @relation(fields: [personId], references: [id])
   
  // Cache de dados do comprador para histórico
  buyerName   String 
  buyerPhone  String

  total       Decimal     @db.Decimal(10, 2)
  status      OrderStatus @default(PENDING) 
   
  // Comprovante de Pagamento
  proofUrl    String?     
  
  items       OrderItem[]
  
  createdAt   DateTime    @default(now())
  paidAt      DateTime?
  deliveredAt DateTime?

  @@map("orders")
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int

  @@map("order_items")
}

model Meeting {
  id        String   @id @default(uuid())
  title     String   // Ex: "Alinhamento Kids", "Reunião Geral"
  date      DateTime 
  type      String   // 'AGENDADA' ou 'REALIZADA'
  notes     String?  // Ata
   
  createdBy String?  // Nome do Staff
  createdAt DateTime @default(now())

  @@map("meetings")
}

model GlobalConfig {
  key   String @id @unique // Ex: "MEETING_COUNT"
  value String
   
  @@map("global_config")
}

enum PersonType {
  MEMBER
  VISITOR
}

enum Role {
  STAFF
  PARTICIPANT
  LEADER
  PASTOR
}

enum CheckpointCategory {
  GENERAL
  KIDS
  PROPHETIC
  PRAYER
  EVANGELISM
  CONSOLIDATION
  STORE
}

enum OrderStatus {
  PENDING
  PAID
  DELIVERED
  CANCELED
}