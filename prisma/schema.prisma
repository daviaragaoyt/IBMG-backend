// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// 1. PESSOAS (LEADS, MEMBROS E STAFF)
// ============================================================================

model Person {
  id              String     @id @default(uuid())
  name            String
  email           String?    @unique // Identificador principal
  phone           String?
  age             Int?
  gender          String?    // 'M' ou 'F'
  
  type            PersonType @default(VISITOR)
  role            Role       @default(PARTICIPANT)
  
  // Apenas para STAFF: define qual tela ele vÃª (STORE, KIDS, RECEPTION)
  department      String?    
  
  church          String?
  marketingSource String?    
    
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  movements       Movement[]
  
  // Relacionamento com as Vendas (Antigo Orders)
  sales           Sale[]     

  @@map("people")
}

// ============================================================================
// 2. LOCAIS E MOVIMENTAÃ‡ÃƒO (RECEPÃ‡ÃƒO, KIDS, ETC)
// ============================================================================

model Checkpoint {
  id            String             @id @default(uuid())
  name          String             @unique
  category      CheckpointCategory @default(GENERAL)

  movements     Movement[]
  manualEntries ManualEntry[]
  sales         Sale[]

  @@map("checkpoints")
}

// Registro automÃ¡tico (ex: leitura de QR Code na portaria)
model Movement {
  id           String     @id @default(uuid())
  timestamp    DateTime   @default(now())
  
  personId     String
  person       Person     @relation(fields: [personId], references: [id])
  checkpointId String
  checkpoint   Checkpoint @relation(fields: [checkpointId], references: [id])

  @@map("movements")
}

// Registro manual (ex: Staff clicando no botÃ£o "+1 Homem")
model ManualEntry {
  id              String     @id @default(uuid())
  timestamp       DateTime   @default(now())
  quantity        Int        @default(1)

  type            PersonType
  gender          String?
  ageGroup        String?
  church          String?
  marketingSource String?    

  checkpointId    String
  checkpoint      Checkpoint @relation(fields: [checkpointId], references: [id])

  @@map("manual_entries")
}

// ============================================================================
// 3. LOJA, PRODUTOS E VENDAS UNIFICADAS
// ============================================================================

model Product {
  id          String   @id @default(uuid())
  name        String
  description String?  // Novo: Para detalhes no modal
  price       Decimal  @db.Decimal(10, 2)
  category    String   // 'CANTINA' (VisualizaÃ§Ã£o) ou 'LOJA' (Venda)
  
  imageUrl    String?  // Imagem principal (Capa)
  images      String[] // Novo: Array de URLs para o Carrossel
  
  saleItems   SaleItem[]

  @@map("products")
}

model Sale {
  id            String   @id @default(uuid())
  timestamp     DateTime @default(now())
  
  total         Decimal  @db.Decimal(10, 2)
  paymentMethod String   
  status        String   @default("PENDING") 
  
  orderCode     String?  
  proofUrl      String?  
  
  buyerName     String?  
  buyerType     PersonType @default(VISITOR)
  
  // ðŸ‘‡ ADICIONE ESTE CAMPO DE VOLTA ðŸ‘‡
  buyerGender   String?    @default("M") 
  // ----------------------------------

  personId      String?
  person        Person?     @relation(fields: [personId], references: [id])

  checkpointId  String?    
  checkpoint    Checkpoint? @relation(fields: [checkpointId], references: [id])
  
  items         SaleItem[]

  @@map("sales")
}

model SaleItem {
  id        String  @id @default(uuid())
  saleId    String
  sale      Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int
  price     Decimal @db.Decimal(10, 2)

  @@map("sale_items")
}

// ============================================================================
// 4. CONFIGURAÃ‡Ã•ES E ADMIN
// ============================================================================

model Meeting {
  id        String   @id @default(uuid())
  title     String   
  date      DateTime 
  type      String   
  notes     String?  
  createdBy String?  
  createdAt DateTime @default(now())

  @@map("meetings")
}

model GlobalConfig {
  key   String @id @unique 
  value String
  
  @@map("global_config")
}

// ============================================================================
// ENUMS
// ============================================================================

enum PersonType {
  MEMBER
  VISITOR
}

enum Role {
  STAFF
  PARTICIPANT
  LEADER
  PASTOR
}

enum CheckpointCategory {
  GENERAL
  KIDS
  PROPHETIC
  PRAYER
  EVANGELISM
  CONSOLIDATION
  STORE
}